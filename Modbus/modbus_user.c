#include "modbus_comm.h"


//变量示例
typedef struct
{
	uint16_t u16Cell[52];
}struct_pack_t;

struct_pack_t gs_packVolt[8] = {
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
};//pack电芯电压

struct_pack_t gs_packTemp[8] = {
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
};//pack电芯温度，计算转有符号

struct_pack_t gs_packSOC[8] = {
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
};//pack电芯SOC

struct_pack_t gs_packSOH[8] = {
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
};//pack电芯SOH

struct_pack_t gs_packIR[8] = {
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
	{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52},
};//pack电芯内阻

typedef struct
{
	uint16_t u16SOC;	//packSOC
	uint16_t u16SOH;	//packSOH
	int16_t s16Temp[4];	//4个极柱温度
}struct_packetStatus_t;

struct_packetStatus_t gs_packetStatus[8] = {
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
	{1,2,3,4,5,6},
};

typedef struct
{
	uint16_t u16RatedEnergy;	//额定能量
	uint16_t u16Volt;			//电压
	uint16_t u16I;				//电流
	uint16_t u16SOC;			//簇SOC
	uint16_t u16SOH;			//簇SOH
	uint16_t u16PermitCharge;	//可充电量
	uint16_t u16PermitDischarge;//可防电量
	uint16_t u16MaxChargePower;	//最大充电功率
	uint16_t u16MaxDishargePower;//最大放电功率
	uint16_t u16Temp;			//温度
}struct_clusterParam_t;

struct_clusterParam_t gs_clusterParam = {
	1,2,3,4,5,6,7,8,9,10
};


//读保持寄存器
eMBErrorCode eMBRegHolding_read( uint8_t * pu8_buf, uint16_t fu16_addr, uint16_t fu16_regNum )
{
    eMBErrorCode eStatus = MB_ENOERR;
    uint16_t lu16_tempVal = 0;

    while(fu16_regNum)
    {
		//簇状态
		if(fu16_addr >= 1500 && fu16_addr < 1510)
		{
			switch(fu16_addr){
				case 1500:lu16_tempVal = gs_clusterParam.u16RatedEnergy;break;
				case 1501:lu16_tempVal = gs_clusterParam.u16Volt;break;
				case 1502:lu16_tempVal = gs_clusterParam.u16I;break;
				case 1503:lu16_tempVal = gs_clusterParam.u16SOC;break;
				case 1504:lu16_tempVal = gs_clusterParam.u16SOH;break;
				case 1505:lu16_tempVal = gs_clusterParam.u16PermitCharge;break;
				case 1506:lu16_tempVal = gs_clusterParam.u16PermitDischarge;break;
				case 1507:lu16_tempVal = gs_clusterParam.u16MaxChargePower;break;
				case 1508:lu16_tempVal = gs_clusterParam.u16MaxDishargePower;break;
				case 1509:lu16_tempVal = gs_clusterParam.u16Temp;break;
				default:lu16_tempVal = 0;break;
			}
		}
		//pack状态
		else if(fu16_addr >= 2500 && fu16_addr < 3500)
		{
			uint16_t lu16_idx = fu16_addr-2500;
			uint16_t lu16_XIdx = lu16_idx/125;
			uint16_t lu16_YIdx = lu16_idx%125;

			switch(lu16_YIdx){
				case 0:lu16_tempVal = gs_packetStatus[lu16_XIdx].u16SOC;break;
				case 1:lu16_tempVal = gs_packetStatus[lu16_XIdx].u16SOH;break;
				case 2:case 3:case 4:case 5:
					lu16_tempVal = gs_packetStatus[lu16_XIdx].s16Temp[lu16_YIdx-2];break;
				default:lu16_tempVal = 0;break;
			}
		}
		else
			lu16_tempVal = 0;
        *pu8_buf++ = (lu16_tempVal>>8) & 0xFF;
        *pu8_buf++ = lu16_tempVal & 0xFF;
        fu16_regNum -= 1;
        fu16_addr += 1;
    }
	
    return eStatus;
}

//读输入寄存器
eMBErrorCode eMBRegInputCB( uint8_t * pu8_buf, uint16_t fu16_addr, uint16_t fu16_regNum )
{  
    eMBErrorCode eStatus = MB_ENOERR;
    uint16_t lu16_tempVal = 0;
	
    while(fu16_regNum)
    {
		if(fu16_addr < 3500)
			lu16_tempVal = 0;
		else if(fu16_addr < 3916)	//电芯电压
		{
			uint16_t lu16_idx = fu16_addr-3500;
			uint16_t lu16_XIdx = lu16_idx/52;
			uint16_t lu16_YIdx = lu16_idx%52;
			lu16_tempVal = gs_packVolt[lu16_XIdx].u16Cell[lu16_YIdx];
		}
		else if(fu16_addr < 4332)	//电芯温度
		{
			uint16_t lu16_idx = fu16_addr-3916;
			uint16_t lu16_XIdx = lu16_idx/52;
			uint16_t lu16_YIdx = lu16_idx%52;
			lu16_tempVal = gs_packTemp[lu16_XIdx].u16Cell[lu16_YIdx];
		}
		else if(fu16_addr < 4748)	//电芯soc
		{
			uint16_t lu16_idx = fu16_addr-4332;
			uint16_t lu16_XIdx = lu16_idx/52;
			uint16_t lu16_YIdx = lu16_idx%52;
			lu16_tempVal = gs_packSOC[lu16_XIdx].u16Cell[lu16_YIdx];
		}
		else if(fu16_addr < 5164)	//电芯soh
		{
			uint16_t lu16_idx = fu16_addr-4748;
			uint16_t lu16_XIdx = lu16_idx/52;
			uint16_t lu16_YIdx = lu16_idx%52;
			lu16_tempVal = gs_packSOH[lu16_XIdx].u16Cell[lu16_YIdx];
		}
		else if(fu16_addr < 5580)	//电芯内阻
		{
			uint16_t lu16_idx = fu16_addr-5164;
			uint16_t lu16_XIdx = lu16_idx/52;
			uint16_t lu16_YIdx = lu16_idx%52;
			lu16_tempVal = gs_packSOH[lu16_XIdx].u16Cell[lu16_YIdx];
		}
		else
			lu16_tempVal = 0;
		
		*pu8_buf++ = (lu16_tempVal>>8) & 0xFF;
        *pu8_buf++ = lu16_tempVal & 0xFF;
        
        fu16_regNum -= 1;
        fu16_addr += 1;
	}

    return eStatus;
}

//写保持寄存器
eMBErrorCode eMBRegHolding_write( uint8_t * pucRegBuffer, uint16_t usAddress, uint16_t usNRegs )
{
    eMBErrorCode eStatus = MB_ENOERR;
	uint16_t lu16_Val[15];
	uint16_t lu16_address = usAddress;
	uint8_t i;

	for(i=0; i<usNRegs; i++)
	{
		lu16_Val[i] = *pucRegBuffer++;
		lu16_Val[i] <<= 8;
		lu16_Val[i] |= *pucRegBuffer++;
	}
	//写数据处理
    return eStatus;
}
//读线圈
eMBErrorCode eMBRegCoils_read( uint8_t * pucRegBuffer, uint16_t usAddress, uint16_t usNRegs)
{
    eMBErrorCode eStatus = MB_ENOREG;
    return eStatus;
}
//写线圈
eMBErrorCode eMBRegCoils_write( uint8_t * pucRegBuffer, uint16_t usAddress, uint16_t usNRegs)
{
    eMBErrorCode eStatus = MB_ENOREG; 
    return eStatus;
}


